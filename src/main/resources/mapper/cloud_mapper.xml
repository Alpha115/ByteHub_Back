<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bytehub.cloud.CloudDAO">
    
    <!-- 파일 업로드 시 cloud 테이블에 저장 -->
    <insert id="insertCloudFile" parameterType="com.bytehub.cloud.CloudDTO">
        INSERT INTO cloud (dept_idx, filename, user_id, created_at)
        VALUES (#{dept_idx}, #{filename}, #{userId}, #{created_at})
    </insert>
    
    <!-- 파일 목록 조회 (정확한 업로더 정보 포함) -->
    <select id="getFileList" parameterType="int" resultType="map">
        SELECT 
            c.file_idx,
            c.dept_idx,
            c.filename,
            c.created_at,
            d.dept_name,
            c.user_id,
            m.name as uploader_name
        FROM cloud c
        LEFT JOIN department d ON c.dept_idx = d.dept_idx
        LEFT JOIN member m ON c.user_id = m.user_id
        WHERE c.dept_idx = #{dept_idx}
        ORDER BY c.created_at DESC
    </select>
    
    <!-- 개별 파일 정보 조회 -->
    <select id="getFileInfo" parameterType="int" resultType="map">
        SELECT 
            c.file_idx,
            c.dept_idx,
            c.filename,
            c.created_at,
            d.dept_name,
            c.user_id,
            m.name as uploader_name
        FROM cloud c
        LEFT JOIN department d ON c.dept_idx = d.dept_idx
        LEFT JOIN member m ON c.user_id = m.user_id
        WHERE c.file_idx = #{fileIdx}
    </select>
    
    <!-- 파일 삭제 -->
    <delete id="deleteCloudFile" parameterType="int">
        DELETE FROM cloud WHERE file_idx = #{fileIdx}
    </delete>
    
    <!-- 다운로드 로그 저장 -->
    <insert id="insertDownLog" parameterType="com.bytehub.cloud.DownLogDTO">
        INSERT INTO download_log (file_idx, user_id, down_time)
        VALUES (#{file_idx}, #{user_id}, NOW())
    </insert>
</mapper>